<launch>

    <!-- mavros 参数设置 -->
	<arg name="fcu_url" default="/dev/ttyTHS0:921600" />
    <!-- <arg name="gcs_url" default="udp://:14550@192.168.xx.xx"(host ip) /> -->
	<arg name="gcs_url" default="udp://:14550@192.168.31.37" />
	<arg name="tgt_system" default="1" />
	<arg name="tgt_component" default="1" />
	<arg name="log_output" default="screen" />
	<arg name="fcu_protocol" default="v2.0" />
	<arg name="respawn_mavros" default="false" />
    <!-- 启动 mavros 节点 -->
    <node pkg="mavros" type="mavros_node" name="mavros" output="screen">
        <param name="fcu_url" value="$(arg fcu_url)"/>
        <param name="gcs_url" value="$(arg gcs_url)"/>
        <param name="tgt_system" value="$(arg tgt_system)"/>
        <param name="tgt_component" value="$(arg tgt_component)"/>
        <param name="log_output" value="$(arg log_output)"/>
        <param name="fcu_protocol" value="$(arg fcu_protocol)"/>
        <param name="fcu_protrespawn_mavrosocol" value="$(arg respawn_mavros)"/>
    </node>

    <!-- vrpn 参数设置 -->
    <arg name="server" default="192.168.1.100" />
    <arg name="port" default="3883" />
    <arg name="update_frequency" default="100.0" />
    <arg name="frame_id" default="world" />
    <!-- 启动 vrpn 节点 -->
    <node pkg="vrpn_client_ros" type="vrpn_client_node" name="vrpn_client_node" output="screen">
        <!-- 传递参数到 vrpn_client_ros 节点 -->
        <rosparam subst_value="true">
        server: $(arg server)
        port: $(arg port)

        update_frequency: $(arg update_frequency)
        frame_id: $(arg frame_id)

        # Use the VRPN server's time, or the client's ROS time.
        use_server_time: false
        broadcast_tf: true

        # Must either specify refresh frequency > 0.0, or a list of trackers to create
        refresh_tracker_frequency: 1.0
        #trackers:
        #- FirstTracker
        #- SecondTracker
        </rosparam>
    </node>


    <!-- pos_estimator 参数设置 -->
    <!-- 0-mocap 1-lslam 2-vslam 3-gazebo 4-others -->
    <arg name="input_source" default="0"/>
    <!-- 0-Z_up 1-Y_up -->
    <arg name="mocap_frame_type" default="0"/>
    <arg name="rigid_body_name" default="uav"/>
    <arg name="rate_hz" default="50"/>

    <!-- 加载外参配置文件 -->
    <rosparam command="load" file="$(find offboard_pkg)/config/extrinsic_params.yaml"/>

    <!-- 启动 pos_estimator 节点 -->
    <node pkg="offboard_pkg" type="pos_estimator" name="pos_estimator_node" output="screen">
        <!-- 传递参数到节点 -->
        <param name="input_source" value="$(arg input_source)"/>
        <param name="mocap_frame_type" value="$(arg mocap_frame_type)"/>
        <param name="rigid_body_name" value="$(arg rigid_body_name)"/>
        <param name="rate_hz" value="$(arg rate_hz)"/>
        <!-- 直接使用yaml中加载的参数命名空间 -->
        <remap from="~extrinsic_x" to="/extrinsic_params/x"/>
        <remap from="~extrinsic_y" to="/extrinsic_params/y"/>
        <remap from="~extrinsic_z" to="/extrinsic_params/z"/>
        <remap from="~extrinsic_roll" to="/extrinsic_params/roll"/>
        <remap from="~extrinsic_pitch" to="/extrinsic_params/pitch"/>
        <remap from="~extrinsic_yaw" to="/extrinsic_params/yaw"/>
    </node>

    <!-- Enable/disable options -->
    <arg name="enable_realsense" default="false"/>

    <!-- 启动realsense -->
    <group if="$(arg enable_realsense)">
        <include file="$(find realsense2_camera)/launch/rs_camera_flight.launch">
        </include>
    </group>

    <!-- rosbag 参数设置 -->
    <arg name="enable_rosbag" default="false"/>
    <arg name="record_path"   default="$(find offboard_pkg)/bag"/>
    <arg name="record_prefix" default="mocap_flight"/>
    
    <!-- 启动 rosbag record 节点 -->
    <group if="$(arg enable_rosbag)">
        <node pkg="rosbag" type="record" name="rosbag_record_node" output="screen"
            args="--output-prefix $(arg record_path)/$(arg record_prefix)
                /mavros/state 
                /mavros/imu/data
                /mavros/vision_pose/pose 
                /mavros/local_position/pose
                /mavros/setpoint_position/local
                /camera/infra1/image_rect_raw
                /camera/infra2/image_rect_raw
                /camera/depth/image_rect_raw
                /camera/color/image_raw
                /camera/imu
                /visualization/current_pose
                /visualization/setpoint_pose
                /vrpn_client_node/$(arg rigid_body_name)/pose
                /trajectory_cmd
                /land_cmd"
        />    
    </group>


</launch>
